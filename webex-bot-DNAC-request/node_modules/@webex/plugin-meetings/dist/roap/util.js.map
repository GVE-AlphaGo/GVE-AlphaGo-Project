{"version":3,"sources":["util.js"],"names":["RoapUtil","ROAP_ANSWER","_ANSWER_","toLowerCase","shouldHandleMedia","meeting","offer","mediaProperties","peerConnection","signalingState","SDP","HAVE_LOCAL_OFFER","handleError","pc","PeerConnectionManager","rollBackLocalDescription","then","resolve","catch","err","reject","findError","messageType","errorType","type","ROAP","RECEIVE_ROAP_MSG","SEND_ROAP_MSG","_ERROR_","_CONFLICT_","ensureMeeting","SEND_ROAP_MSG_SUCCESS","updatePeerConnection","session","offerSdp","OFFER","sdps","id","res","roap","lastRoapOffer","setRemoteDescription","LoggerProxy","logger","info","correlationId","error","ParameterError","setRemoteSessionDetails","ANSWER","seq","locusId","locusSelfId","locusInfo","self","mediaId"],"mappings":"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","file":"util.js","sourcesContent":["\nimport PeerConnectionManager from '../peer-connection-manager';\nimport {\n  _ANSWER_,\n  _ERROR_,\n  _CONFLICT_,\n  ROAP,\n  SDP\n} from '../constants';\nimport LoggerProxy from '../common/logs/logger-proxy';\nimport ParameterError from '../common/errors/parameter';\n\nconst RoapUtil = {};\nconst ROAP_ANSWER = _ANSWER_.toLowerCase();\n\nRoapUtil.shouldHandleMedia = (meeting) => {\n  const offer =\n    meeting.mediaProperties.peerConnection &&\n    meeting.mediaProperties.peerConnection.signalingState === SDP.HAVE_LOCAL_OFFER;\n\n  if (offer) {\n    return false;\n  }\n\n  return true;\n};\n\nRoapUtil.handleError = (pc) =>\n  PeerConnectionManager.rollBackLocalDescription({peerConnection: pc})\n    .then(() => Promise.resolve(true))\n    .catch((err) => Promise.reject(err));\n\nRoapUtil.findError = (messageType, errorType, type) =>\n  (type === ROAP.RECEIVE_ROAP_MSG || type === ROAP.SEND_ROAP_MSG) && messageType === _ERROR_ && errorType === _CONFLICT_;\n\nRoapUtil.ensureMeeting = (meeting, type) => {\n  if (type === ROAP.RECEIVE_ROAP_MSG || type === ROAP.SEND_ROAP_MSG || type === ROAP.SEND_ROAP_MSG_SUCCESS) {\n    if (!meeting) {\n      return false;\n    }\n  }\n\n  return true;\n};\n\nRoapUtil.updatePeerConnection = (meeting, session) => PeerConnectionManager.updatePeerConnection({\n  offerSdp: session.OFFER.sdps,\n  peerConnection: meeting.mediaProperties.peerConnection\n},\nmeeting.id)\n  .then((res) => {\n    meeting.roap.lastRoapOffer = session.OFFER.sdps;\n\n    return res;\n  });\n\n\nRoapUtil.setRemoteDescription = (meeting, session) => {\n  LoggerProxy.logger.info(`RoapUtil->setRemoteDescription#Transmit WAIT_TX_OK, correlationId: ${meeting.correlationId}`);\n  if (!(meeting && (meeting.mediaProperties.peerConnection))) {\n    LoggerProxy.logger.error(`RoapUtil->setRemoteDescription#DANGER no media or screen peer connection, correlationId: ${meeting.correlationId}`);\n\n    return Promise.reject(new ParameterError('Must provide a media or screen peer connection'));\n  }\n\n  return PeerConnectionManager.setRemoteSessionDetails(\n    meeting.mediaProperties.peerConnection,\n    ROAP_ANSWER,\n    session.ANSWER.sdps[0],\n    meeting.id\n  ).then(() => {\n    LoggerProxy.logger.info(`RoapUtil->setRemoteDescription#Success for correlationId: ${meeting.correlationId}`);\n\n    return {\n      seq: session.ANSWER.seq,\n      locusId: meeting.locusId,\n      locusSelfId: meeting.locusInfo.self.id,\n      mediaId: meeting.mediaId,\n      correlationId: meeting.correlationId\n    };\n  })\n    .catch((err) => {\n      throw err;\n    });\n};\n\nexport default RoapUtil;\n"]}