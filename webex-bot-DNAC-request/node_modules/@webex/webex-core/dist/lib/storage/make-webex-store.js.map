{"version":3,"sources":["make-webex-store.js"],"names":["makeWebexStore","bindings","type","webex","WebexStore","keyFactory","namespace","logger","debug","set","promises","forEach","binding","push","clear","all","key","_getBinding","then","del","get","value","put","serialize","resolve","adapter","bind","_binding","config","storage","prototype","Events"],"mappings":"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","file":"make-webex-store.js","sourcesContent":["/*!\n * Copyright (c) 2015-2019 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport Events from 'ampersand-events';\nimport {oneFlight} from '@webex/common';\n\nconst bindings = new WeakMap();\n\n/**\n * Makes a WebexStore for the specified type bound to the specified webex instance\n * @param {string} type\n * @param {ProxyWebex} webex\n * @private\n * @returns {WebexStore}\n */\nexport default function makeWebexStore(type, webex) {\n  /**\n   * Lazy Key-Value Store Interface\n   */\n  class WebexStore {\n    /**\n     * @param {Object} attrs\n     * @param {Object} options\n     * @returns {Store}\n     */\n    constructor() {\n      webex.logger.debug(`webex-store: constructing ${type}Storage`);\n      bindings.set(this, new Map());\n    }\n\n    /**\n     * Provides easy access to the storage adapter identified in config.\n     * @returns {Object}\n     */\n    get adapter() {\n      return webex.config.storage[`${type}Adapter`];\n    }\n\n    /**\n     * @returns {WeakMap}\n     */\n    get bindings() {\n      return bindings.get(this);\n    }\n\n    /**\n     * Clears the store\n     * @returns {Promise}\n     */\n    clear() {\n      const promises = [];\n\n      this.bindings.forEach((binding) => {\n        promises.push(binding.clear());\n      });\n\n      return Promise.all(promises);\n    }\n\n    /**\n     * Deletes the specified key from the store\n     * @param {string} namespace\n     * @param {string} key\n     * @returns {[type]}\n     */\n    del(namespace, key) {\n      webex.logger.debug(`webex-store: removing ${namespace}:${key}`);\n\n      return this._getBinding(namespace)\n        .then((binding) => binding.del(key));\n    }\n\n    /**\n     * Retrieves the value specified by key from the store. Rejects with\n     * NotFoundError if no value can be found\n     * @param {string} namespace\n     * @param {string} key\n     * @returns {Promise}\n     */\n    get(namespace, key) {\n      webex.logger.debug(`webex-store: retrieving ${namespace}:${key}`);\n\n      return this._getBinding(namespace)\n        .then((binding) => binding.get(key));\n    }\n\n    /**\n     * Writes a value to the store. Deletes the specified key from the store\n     * if passed `undefined`\n     * @param {string} namespace\n     * @param {string} key\n     * @param {any} value\n     * @returns {Promise} Resolves with value (to simplify write-through caching)\n     */\n    put(namespace, key, value) {\n      if (typeof value === 'undefined') {\n        return this.del(namespace, key);\n      }\n      webex.logger.debug(`webex-store: setting ${namespace}:${key}`);\n\n      return this._getBinding(namespace)\n        .then((binding) => binding.put(key, value.serialize ? value.serialize() : value))\n        .then(() => value);\n    }\n\n    @oneFlight({keyFactory: (namespace) => namespace})\n    /**\n     * Creates an interface bound to the specified namespace\n     * @param {string} namespace\n     * @private\n     * @returns {Promise}\n     */\n    // suppress doc warning because decorators confuse eslint\n    // eslint-disable-next-line require-jsdoc\n    _getBinding(namespace) {\n      return new Promise((resolve) => {\n        webex.logger.debug(`storage: getting binding for \\`${namespace}\\``);\n        const binding = this.bindings.get(namespace);\n\n        if (binding) {\n          webex.logger.debug(`storage: found binding for \\`${namespace}\\``);\n\n          return resolve(binding);\n        }\n\n        return resolve(this.adapter.bind(namespace, {logger: webex.logger})\n          .then((_binding) => {\n            webex.logger.debug(`storage: made binding for \\`${namespace}\\``);\n            this.bindings.set(namespace, _binding);\n\n            return _binding;\n          }));\n      });\n    }\n  }\n\n  Object.assign(WebexStore.prototype, Events);\n\n  return new WebexStore();\n}\n"]}